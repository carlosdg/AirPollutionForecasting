-- Clean previous tables if they exist

DROP TABLE IF EXISTS fact_measure;
DROP TABLE IF EXISTS dim_date;
DROP TABLE IF EXISTS dim_time;
DROP TABLE IF EXISTS dim_duration;
DROP TABLE IF EXISTS dim_station;
DROP TABLE IF EXISTS dim_measurement_type;


-- Definition of the dimension tables

CREATE TABLE dim_date(
  sql_date DATE NOT NULL,
  year INT NOT NULL,
  month INT NOT NULL,
  week_of_year INT NOT NULL,
  day INT NOT NULL,
  day_of_week INT NOT NULL,
  day_of_year INT NOT NULL,
  is_tenerife_holiday boolean NOT NULL,   -- Flag to know if the day is holiday (not counting weekend unless the holiday is on weekend of course)
  tenerife_holiday_name text NOT NULL,    -- Holiday name or 'NO HOLIDAY'
  is_weekend boolean NOT NULL,             -- Flag to know whether the date is Saturday or Sunday
  _id SERIAL PRIMARY KEY
);

CREATE TABLE dim_time(
  hour INT NOT NULL,         -- from 0 to 23
  _id SERIAL PRIMARY KEY
);

CREATE TABLE dim_duration(
  duration_type VARCHAR(15) NOT NULL,   -- 'HOURLY', 'DIARY'
  duration_hours INT NOT NULL,           -- 1 or 24
  _id SERIAL PRIMARY KEY
);

CREATE TABLE dim_station(
  source VARCHAR(30) NOT NULL,    -- Where did the data come from
  owner VARCHAR(30) NOT NULL,     -- To who does the station belong
  zone VARCHAR(30) NOT NULL,      -- Where is located
  name VARCHAR(60) NOT NULL,      -- Station name
  latitude NUMERIC NOT NULL,
  longitude NUMERIC NOT NULL,
  altitude NUMERIC NOT NULL,
  _id SERIAL PRIMARY KEY
);

CREATE TABLE dim_measurement_type(
  short_measure_name VARCHAR(10) NOT NULL,
  measure_name VARCHAR(60) NOT NULL,
  unit VARCHAR(30) NOT NULL,
  _id SERIAL PRIMARY KEY
);


-- Definition of the fact tables

CREATE TABLE fact_measure(
  date SERIAL REFERENCES dim_date,
  time SERIAL REFERENCES dim_time,
  duration SERIAL REFERENCES dim_duration,
  source SERIAL REFERENCES dim_station,
  measurement_type SERIAL REFERENCES dim_measurement_type,
  value FLOAT,
  _id SERIAL PRIMARY KEY
);


-- Definition of a function to get the holiday names
-- (Note: for now, for simplicity we got and put directly the holy week 
-- and carnival days so we don't have a very complex to understand algorithm)

CREATE OR REPLACE FUNCTION get_holiday(date DATE)
RETURNS TEXT
AS $$
  DECLARE
    day INT := EXTRACT(day FROM date);
    month INT := EXTRACT(month FROM date);
    year INT := EXTRACT(year FROM date);
  BEGIN
    RETURN CASE
      WHEN (month = 1) AND (day = 1) THEN 'NEW YEAR'
      WHEN (month = 1) AND (day = 6) THEN 'EPIPHANY'
      WHEN (month = 5) AND (day = 1) THEN 'LABOR DAY'
      WHEN (month = 5) AND (day = 30) THEN 'DAY OF THE CANARY ISLANDS'
      WHEN (month = 8) AND (day = 15) THEN 'ASSUMPTION OF MARY'
      WHEN (month = 10) AND (day = 12) THEN 'HISPANIC DAY'
      WHEN (month = 11) AND (day = 1) THEN 'ALL SAINTS'
      WHEN (month = 12) AND (day = 6) THEN 'CONSTITUTION DAY'
      WHEN (month = 12) AND (day = 8) THEN 'IMMACULATE CONCEPTION'
      WHEN (month = 12) AND (day = 25) THEN 'CHRISTMAS DAY'
    ELSE CASE
      WHEN (year = 2015) AND (month = 2) AND (day = 17) THEN '(CARNIVAL) SHROVE TUESDAY'
      WHEN (year = 2015) AND (month = 4) AND (day = 2) THEN '(HOLY WEEK) MAUNDY THURSDAY'
      WHEN (year = 2015) AND (month = 4) AND (day = 3) THEN '(HOLY WEEK) GOOD FRIDAY'
      
      WHEN (year = 2016) AND (month = 2) AND (day = 9) THEN '(CARNIVAL) SHROVE TUESDAY'
      WHEN (year = 2016) AND (month = 3) AND (day = 24) THEN '(HOLY WEEK) MAUNDY THURSDAY'
      WHEN (year = 2016) AND (month = 3) AND (day = 25) THEN '(HOLY WEEK) GOOD FRIDAY'

      WHEN (year = 2017) AND (month = 2) AND (day = 28) THEN '(CARNIVAL) SHROVE TUESDAY'
      WHEN (year = 2017) AND (month = 4) AND (day = 13) THEN '(HOLY WEEK) MAUNDY THURSDAY'
      WHEN (year = 2017) AND (month = 4) AND (day = 14) THEN '(HOLY WEEK) GOOD FRIDAY'

      WHEN (year = 2018) AND (month = 2) AND (day = 13) THEN '(CARNIVAL) SHROVE TUESDAY'
      WHEN (year = 2018) AND (month = 3) AND (day = 29) THEN '(HOLY WEEK) MAUNDY THURSDAY'
      WHEN (year = 2018) AND (month = 3) AND (day = 30) THEN '(HOLY WEEK) GOOD FRIDAY'

      WHEN (year = 2019) AND (month = 3) AND (day = 5) THEN '(CARNIVAL) SHROVE TUESDAY'
      WHEN (year = 2019) AND (month = 4) AND (day = 18) THEN '(HOLY WEEK) MAUNDY THURSDAY'
      WHEN (year = 2019) AND (month = 4) AND (day = 19) THEN '(HOLY WEEK) GOOD FRIDAY'
      ELSE 'NOT HOLIDAY'
    END -- INNER CASE
  END;  -- OUTER CASE
 END    -- BEGIN
$$ LANGUAGE plpgsql;


-- Insertion of static values to the dimension tables

INSERT INTO dim_date
SELECT curr_date::DATE as sql_date
    , EXTRACT(year FROM curr_date) AS year
    , EXTRACT(month FROM curr_date) AS month
    , EXTRACT(week FROM curr_date) AS week_of_year
    , EXTRACT(day FROM curr_date) AS day
    , EXTRACT(isodow FROM curr_date) AS day_of_week
    , EXTRACT(doy FROM curr_date) AS day_of_year
    , get_holiday(curr_date::DATE) != 'NOT HOLIDAY' AS is_tenerife_holiday
    , get_holiday(curr_date::DATE) AS tenerife_holiday_name
    , EXTRACT(isodow FROM curr_date) >= 6 AS is_weekend
FROM generate_series(
  TIMESTAMP WITHOUT TIME ZONE '2015/1/1',
  TIMESTAMP WITHOUT TIME ZONE '2019/12/31',
  INTERVAL '1 day') AS curr_date;

INSERT INTO dim_time
SELECT *
FROM generate_series(0, 23) AS hour;

INSERT INTO dim_duration VALUES 
('daily', 24), 
('hourly', 1);

INSERT INTO dim_station VALUES
('CANARY GOVERNMENT', 'CEPSA', 'SANTA CRUZ - LA LAGUNA', 'CASA CUNA', -16.27769219311504, 28.45103088037192, 0),
('CANARY GOVERNMENT', 'CEPSA', 'SANTA CRUZ - LA LAGUNA', 'DEPOSITO DE TRISTAN', -16.27877561502283, 28.45815968532356, 0),
('CANARY GOVERNMENT', 'CEPSA', 'SANTA CRUZ - LA LAGUNA', 'GARCIA ESCAMEZ', -16.27184954317193, 28.45664139423877, 0),
('CANARY GOVERNMENT', 'CEPSA', 'SANTA CRUZ - LA LAGUNA', 'PARQUE LA GRANJA', -16.26487493264499, 28.46300210751911, 0),
('CANARY GOVERNMENT', 'CANARY GOVERNMENT', 'SANTA CRUZ - LA LAGUNA', 'TOME CANO', -16.26186591001509, 28.4621688991889, 0),
('CANARY GOVERNMENT', 'CEPSA', 'SANTA CRUZ - LA LAGUNA', 'VUELTA LOS PAJAROS', -16.27697222222222, 28.462, 0),
('CANARY GOVERNMENT', 'CANARY GOVERNMENT', 'SANTA CRUZ - LA LAGUNA', 'PISCINA MUNICIPAL', -16.26340423894506, 28.45791579546199, 0),
('CANARY GOVERNMENT', 'CANARY GOVERNMENT', 'SANTA CRUZ - LA LAGUNA', 'TENA ARTIGAS', -16.27685561780176, 28.45537560999706, 0),
('CANARY GOVERNMENT', 'CANARY GOVERNMENT', 'SANTA CRUZ - LA LAGUNA', 'TIO PINO', -16.27012462756456, 28.45925503570103, 0),
('CANARY GOVERNMENT', 'CANARY GOVERNMENT', 'SANTA CRUZ - LA LAGUNA', 'PALMETUM', -16.25852644443512, 28.452545726989584, 0),
('CANARY GOVERNMENT', 'CANARY GOVERNMENT', 'SANTA CRUZ - LA LAGUNA', 'COMANDANCIA', -16.2456057616887, 28.47720124167907, 0),
('CANARY GOVERNMENT', 'CANARY GOVERNMENT', 'SANTA CRUZ - LA LAGUNA', 'HACIENDA', -16.24870801361327, 28.46323011938556, 0),
('CANARY GOVERNMENT', 'CANARY GOVERNMENT', 'SANTA CRUZ - LA LAGUNA', 'BOMBEROS', -16.26097493125278, 28.45828864775618, 0),
('CANARY GOVERNMENT', 'CANARY GOVERNMENT', 'SANTA CRUZ - LA LAGUNA', 'COMISARIA', -16.25866186061195, 28.45912395381277, 0),
('CANARY GOVERNMENT', 'UNKNOWN', 'SANTA CRUZ - LA LAGUNA', 'LOS GLADIOLOS', 0, 0, 0),
('CANARY GOVERNMENT', 'UNKNOWN', 'SANTA CRUZ - LA LAGUNA', 'MERCATENERIFE', 0, 0, 0),
('CANARY GOVERNMENT', 'UNKNOWN', 'SANTA CRUZ - LA LAGUNA', 'PUERTA LITORAL - REFINERIA', 0, 0, 0),
('CANARY GOVERNMENT', 'UNKNOWN', 'SANTA CRUZ - LA LAGUNA', 'PUERTA PRINCIPAL - REFINERIA', 0, 0, 0),
('CANARY GOVERNMENT', 'UNKNOWN', 'SANTA CRUZ - LA LAGUNA', 'REFINERIA', 0, 0, 0),
('CANARY GOVERNMENT', 'UNKNOWN', 'SANTA CRUZ - LA LAGUNA', 'REFINERIA - TORRE METEOROLOGICA', 0, 0, 0),
('CANARY GOVERNMENT', 'UNKNOWN', 'SANTA CRUZ - LA LAGUNA', 'VIEJA Y CLAVIJO', 0, 0, 0),
('CANARY GOVERNMENT', 'CANARY GOVERNMENT', 'TENERIFE NORTH', 'LA ZAMORA', -16.57072474718117, 28.3831334121515, 0),
('CANARY GOVERNMENT', 'CANARY GOVERNMENT', 'TENERIFE SOUTH', 'LA HIDALGA - ARAFO', -16.39991556602504, 28.33734903726858, 0),
('CANARY GOVERNMENT', 'ENDESA', 'TENERIFE SOUTH', 'BARRANCO HONDO', -16.3581166775973, 28.39342430257058, 0),
('CANARY GOVERNMENT', 'ENDESA', 'TENERIFE SOUTH', 'LA BUZANADA', -16.65275205038472, 28.07264560673482, 0),
('CANARY GOVERNMENT', 'ENDESA', 'TENERIFE SOUTH', 'CALETILLAS', -16.36193673089008, 28.37672185381682, 0),
('CANARY GOVERNMENT', 'ENDESA', 'TENERIFE SOUTH', 'LA GUANCHA - CANDELARIA', -16.36833427699988, 28.38016131594777, 0),
('CANARY GOVERNMENT', 'ENDESA', 'TENERIFE SOUTH', 'EL RIO', -16.52369883375512, 28.14507452830099, 0),
('CANARY GOVERNMENT', 'ENDESA', 'TENERIFE SOUTH', 'LAS GALLETAS', -16.65582224157534, 28.00778986209971, 0),
('CANARY GOVERNMENT', 'ENDESA', 'TENERIFE SOUTH', 'GRANADILLA', -16.57757403405965, 28.11249291171923, 0),
('CANARY GOVERNMENT', 'ENDESA', 'TENERIFE SOUTH', 'IGUESTE', -16.37197069941999, 28.38054612249282, 0),
('CANARY GOVERNMENT', 'ENDESA', 'TENERIFE SOUTH', 'EL MEDANO', -16.53603007019015, 28.04732410738179, 0),
('CANARY GOVERNMENT', 'ENDESA', 'TENERIFE SOUTH', 'SAN ISIDRO', -16.55983699771885, 28.08003389965855, 0),
('CANARY GOVERNMENT', 'ENDESA', 'TENERIFE SOUTH', 'SAN MIGUEL DE TAJAO', -16.47161086862779, 28.11139253073869, 0),
('CANARY GOVERNMENT', 'UNKNOWN', 'TENERIFE SOUTH', 'TORRE METEOROLOGICA DE CANDELARIA', 0, 0, 0),
('AEMET', 'AEMET', 'SANTA CRUZ - LA LAGUNA', 'SANTA CRUZ DE TENERIFE', 28.46333333, -16.25527778, 35),
('AEMET', 'AEMET', 'TENERIFE NORTH', 'AEROPUERTO NORTE', 28.4775, -16.329444444444444, 632),
('AEMET', 'AEMET', 'TENERIFE SOUTH', 'AEROPUERTO SUR', 28.047500000000003, -16.560833333333335, 64),
('AEMET', 'AEMET', 'TENERIFE SOUTH', 'IZANA', 28.30888888888889, -16.499444444444446, 2371),
('AEMET', 'AEMET', 'TENERIFE SOUTH', 'GUIMAR', 28.31833333333333, -16.38222222222222, 115),
('AEMET', 'AEMET', 'TENERIFE NORTH', 'PUERTO DE LA CRUZ', 28.418055555555558, -16.548055555555557, 25);


INSERT INTO dim_measurement_type VALUES
('TMIN', 'MINIMUM TEMPERATURE', 'CELSIUS DEGREES'),
('TMINHOUR', 'HOUR OF MINIMUM TEMPERATURE', 'h'),
('TMAX', 'MAXIMUM TEMPERATURE', 'CELSIUS DEGREES'),
('TMAXHOUR', 'HOUR OF MAXIMUM TEMPERATURE', 'h'),
('WSMAX', 'MAXIMUM WIND SPEED', 'm/s'),
('WSMAXDIR', 'DIRECTION OF MAXIMUM WIND SPEED', 'DEGREES'),
('WSMAXHOUR', 'HOUR OF MAXIMUM WIND SPEED', 'h'),
('SUN', 'HOURS OF SUN', 'h'),
('PMIN', 'MINIMUM PRESSURE', 'mb'),
('PMINHOUR', 'HOUR OF MINIMUM PRESSURE', 'h'),
('PMAX', 'MAXIMUM PRESSURE', 'mb'),
('PMAXHOUR', 'HOUR OF MAXIMUM PRESSURE', 'h'),
('T', 'TEMPERATURE', 'CELSIUS DEGREES'),
('P', 'ATMOSPHERIC PRESSURE', 'mb'),
('WD', 'WIND DIRECTION', 'DEGREES'),
('WS', 'WIND SPEED', 'm/s'),
('RH', 'RELATIVE HUMIDITY', '%'),
('PP', 'PRECIPITATION', 'l/m2'),
('SR', 'SOLAR RADIATION', 'W/m2'),
('PM10', 'PARTICULATE MATTER LESS THAN 10 MICROMETERS', 'µg/m3'),
('PM2.5', 'PARTICULATE MATTER LESS THAN 2.5 MICROMETERS', 'µg/m3'),
('PM1', 'PARTICULATE MATTER LESS THAN 1 MICROMETER', 'µg/m3'),
('O3', 'OZONE', 'µg/m3'),
('CO', 'CARBON MONOXIDE', 'mg/m3'),
('H2S', 'HYDROGEN SULFIDE', 'µg/m3'),
('NO', 'NITROGEN MONOXIDE', 'µg/m3'),
('NO2', 'NITROGEN DIOXIDE', 'µg/m3'),
('NOX', 'NITROGEN OXIDES', 'µg/m3'),
('SH2', 'HYDROGEN SULFIDE', 'µg/m3'),
('SO2', 'SULFUR DIOXIDE', 'µg/m3'),
('TRS', 'TOTAL REDUCED SULPHUR', 'µg/m3'),
('BC', 'BLACK CARBON', 'µg/m3'),
('BEN', 'BENCENE', 'µg/m3'),
('TOL', 'TOLUENE', 'µg/m3'),
('XIL', 'XYLENE', 'µg/m3'),
('M-P XIL', 'M-P XYLENE', 'µg/m3');